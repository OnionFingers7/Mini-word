<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#2563eb" />
  <title>Mini Word ‚Äî Offline-ready</title>
  <style>
    :root{--toolbar-bg:#f3f4f6;--btn-bg:#fff;--accent:#2563eb}
    html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;background:#fafafa;color:#111}
    header{padding:10px 12px;background:linear-gradient(180deg,#fff,#f7f7fb);border-bottom:1px solid #e6e6e9}
    h1{margin:0;font-size:18px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;padding:10px;border-radius:8px;background:var(--toolbar-bg);align-items:center}
    .toolbar select,.toolbar input[type=color],.toolbar button{padding:8px;border-radius:8px;border:1px solid #ddd;background:var(--btn-bg);font-size:15px}
    .toolbar button{min-width:40px}
    .toolbar .small{font-size:13px}
    #editor{min-height:60vh;border:1px solid #ddd;padding:14px;margin:12px;border-radius:8px;background:white;overflow:auto;box-sizing:border-box}
    .file-controls{margin-left:auto;display:flex;gap:8px;align-items:center}
    .status{font-size:13px;color:#666}
    .find-replace{display:none;position:fixed;right:16px;top:80px;background:white;padding:10px;border:1px solid #ddd;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.08);z-index:40}
    footer{padding:10px;color:#666;font-size:13px}
    @media(max-width:720px){
      .toolbar{position:fixed;left:0;right:0;bottom:0;padding:6px;gap:6px;z-index:40;border-top:1px solid #e6e6e9}
      header{padding-bottom:56px}
      #editor{margin:12px 12px 80px 12px}
      .file-controls{margin-left:0}
      .toolbar select,.toolbar button,.toolbar input[type=color]{padding:10px;font-size:16px}
    }
    button:focus,select:focus,input:focus{outline:2px solid rgba(37,99,235,0.18)}
  </style>
</head>
<body>
  <header>
    <h1>Mini Word ‚Äî Offline-ready</h1>

    <div class="toolbar" role="toolbar" aria-label="Formatting toolbar">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <select id="fontFamily" title="Font family">
          <option value="Arial">Arial</option>
          <option value="Times New Roman">Times New Roman</option>
          <option value="Georgia">Georgia</option>
          <option value="Courier New">Courier New</option>
          <option value="Verdana">Verdana</option>
        </select>

        <select id="fontSize" title="Font size">
          <option value="12px">12</option>
          <option value="14px" selected>14</option>
          <option value="16px">16</option>
          <option value="18px">18</option>
          <option value="24px">24</option>
          <option value="32px">32</option>
        </select>

        <button id="boldBtn" title="Bold"><b>B</b></button>
        <button id="italicBtn" title="Italic"><i>I</i></button>
        <button id="underlineBtn" title="Underline"><u>U</u></button>
        <button id="strikeBtn" title="Strikethrough"><s>S</s></button>

        <input id="textColor" type="color" title="Text color" value="#000000">
        <input id="highlightColor" type="color" title="Highlight color" value="#fff176">

        <button id="olBtn" title="Ordered list">1.</button>
        <button id="ulBtn" title="Unordered list">‚Ä¢</button>
        <button id="leftBtn" title="Align left">L</button>
        <button id="centerBtn" title="Center">C</button>
        <button id="rightBtn" title="Align right">R</button>

        <button id="undoBtn" title="Undo">‚Ü∂</button>
        <button id="redoBtn" title="Redo">‚Ü∑</button>

        <button id="insertImageBtn" title="Insert image">üñºÔ∏è</button>
        <button id="insertTableBtn" title="Insert table">‚ñ¶</button>

        <div class="small" style="display:flex;gap:6px;align-items:center;margin-left:6px">
          <button id="zoomOutBtn" title="Zoom out">‚àí</button>
          <span id="zoomLabel">100%</span>
          <button id="zoomInBtn" title="Zoom in">Ôºã</button>
        </div>

        <label style="margin-left:8px"><input type="checkbox" id="autosaveToggle"> Autosave</label>
        <button id="restoreAutoBtn" title="Restore autosave">Restore</button>

        <label style="margin-left:8px"><input type="checkbox" id="spellToggle" checked> Spellcheck</label>
      </div>

      <div class="file-controls">
        <input id="fileInput" type="file" accept=".docx,.doc,.html,.htm,.txt,.png,.jpg,.jpeg" style="display:none">
        <input id="imgInput" type="file" accept="image/*" style="display:none">

        <button id="openBtn">Open</button>
        <button id="saveDocxBtn">Save .docx</button>
        <button id="saveHtmlBtn">Save .html</button>
        <button id="saveTxtBtn">Save .txt</button>
        <button id="savePdfBtn" title="Print / Save as PDF">Print/PDF</button>

        <button id="findBtn" title="Find/Replace">Find</button>
        <span class="status" id="wordCount">Words: 0</span>
      </div>
    </div>
  </header>

  <main>
    <div id="editor" contenteditable="true" spellcheck="true" aria-label="Document editor">
      <p>Start typing here... select text and use the toolbar to format.</p>
    </div>
  </main>

  <div class="find-replace" id="findReplaceBox" role="dialog" aria-label="Find and replace">
    <div style="display:flex;gap:8px;align-items:center">
      <input id="findInput" placeholder="Find...">
      <input id="replaceInput" placeholder="Replace...">
      <button id="findNextBtn">Next</button>
      <button id="replaceBtn">Replace</button>
      <button id="replaceAllBtn">Replace All</button>
      <button id="closeFindBtn">√ó</button>
    </div>
  </div>

  <footer>
    Files are handled locally in your browser. This page is offline-capable (Service Worker &amp; PWA manifest). First load: please open this page while online so the browser can cache required assets.
  </footer>

  <!-- Libraries (will be cached on first load) -->
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
  <script src="https://unpkg.com/html-docx-js@0.4.1/dist/html-docx.js"></script>

  <script>
    // ---------- Core editor logic ----------
    const editor = document.getElementById('editor');
    const AUTOKEY = 'mini_word_autosave_v2';
    let autosaveInterval = null;
    let zoom = 1;

    function exec(command, value=null){ document.execCommand(command, false, value); editor.focus(); updateActiveButtons(); updateWordCount(); }

    // basic toolbar wiring
    document.getElementById('boldBtn').onclick = ()=> exec('bold');
    document.getElementById('italicBtn').onclick = ()=> exec('italic');
    document.getElementById('underlineBtn').onclick = ()=> exec('underline');
    document.getElementById('strikeBtn').onclick = ()=> exec('strikeThrough');
    document.getElementById('olBtn').onclick = ()=> exec('insertOrderedList');
    document.getElementById('ulBtn').onclick = ()=> exec('insertUnorderedList');
    document.getElementById('leftBtn').onclick = ()=> exec('justifyLeft');
    document.getElementById('centerBtn').onclick = ()=> exec('justifyCenter');
    document.getElementById('rightBtn').onclick = ()=> exec('justifyRight');
    document.getElementById('undoBtn').onclick = ()=> exec('undo');
    document.getElementById('redoBtn').onclick = ()=> exec('redo');

    document.getElementById('fontFamily').onchange = ()=> exec('fontName', document.getElementById('fontFamily').value);
    document.getElementById('fontSize').onchange = ()=> wrapSelectionWithStyle({fontSize: document.getElementById('fontSize').value});
    document.getElementById('textColor').onchange = (e)=> exec('foreColor', e.target.value);
    document.getElementById('highlightColor').onchange = (e)=> exec('hiliteColor', e.target.value);

    // Insert image (picker)
    const imgInput = document.getElementById('imgInput');
    document.getElementById('insertImageBtn').onclick = ()=> imgInput.click();
    imgInput.onchange = async (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{ exec('insertHTML', `<img src="${reader.result}" style="max-width:100%;display:block;margin:8px 0">`); };
      reader.readAsDataURL(file);
      imgInput.value = '';
    };

    // Insert table
    document.getElementById('insertTableBtn').onclick = ()=>{
      const r = parseInt(prompt('Rows', '2')); const c = parseInt(prompt('Cols', '2'));
      if(!r||!c) return;
      let html = '<table border="1" style="border-collapse:collapse;width:100%">';
      for(let i=0;i<r;i++){ html += '<tr>'; for(let j=0;j<c;j++){ html += '<td>&nbsp;</td>'; } html += '</tr>'; }
      html += '</table><p></p>';
      exec('insertHTML', html);
    };

    // Zoom
    function setZoom(v){ zoom = v; document.getElementById('zoomLabel').textContent = Math.round(zoom*100)+'%'; editor.style.zoom = zoom; }
    document.getElementById('zoomInBtn').onclick = ()=> setZoom(Math.min(2, zoom+0.1));
    document.getElementById('zoomOutBtn').onclick = ()=> setZoom(Math.max(0.5, zoom-0.1));

    // Autosave
    const autosaveToggle = document.getElementById('autosaveToggle');
    document.getElementById('restoreAutoBtn').onclick = ()=>{
      const data = localStorage.getItem(AUTOKEY); if(!data) return alert('No autosave found');
      if(confirm('Restore autosaved content? This will replace current editor content.')){ editor.innerHTML = data; updateWordCount(); }
    };
    autosaveToggle.onchange = ()=>{
      if(autosaveToggle.checked){
        localStorage.setItem(AUTOKEY, editor.innerHTML);
        autosaveInterval = setInterval(()=> localStorage.setItem(AUTOKEY, editor.innerHTML), 3000);
        flashStatus('Autosave ON');
      }else{ clearInterval(autosaveInterval); autosaveInterval = null; flashStatus('Autosave OFF'); }
    };

    // Find / Replace panel
    const findBox = document.getElementById('findReplaceBox');
    document.getElementById('findBtn').onclick = ()=> { findBox.style.display = findBox.style.display==='block' ? 'none' : 'block'; document.getElementById('findInput').focus(); };
    document.getElementById('closeFindBtn').onclick = ()=> findBox.style.display='none';
    document.getElementById('findNextBtn').onclick = ()=>{ const q = document.getElementById('findInput').value; if(!q) return; window.find(q, false, false, true, false, false, false); };
    document.getElementById('replaceBtn').onclick = ()=>{
      const q = document.getElementById('findInput').value; const r = document.getElementById('replaceInput').value; if(!q) return;
      const sel = window.getSelection(); if(sel.rangeCount){ const text = sel.toString(); if(text===q){ exec('insertText', r); return; } }
      const re = new RegExp(escapeRegExp(q)); editor.innerHTML = editor.innerHTML.replace(re, r); updateWordCount();
    };
    document.getElementById('replaceAllBtn').onclick = ()=>{
      const q = document.getElementById('findInput').value; const r = document.getElementById('replaceInput').value; if(!q) return;
      const re = new RegExp(escapeRegExp(q), 'g'); editor.innerHTML = editor.innerHTML.replace(re, r); updateWordCount();
    };
    function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&'); }

    // Open files
    const fileInput = document.getElementById('fileInput');
    document.getElementById('openBtn').onclick = ()=> fileInput.click();
    fileInput.onchange = async (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const name = file.name.toLowerCase();
      if(name.endsWith('.docx')){
        const arrayBuffer = await file.arrayBuffer();
        try{ const result = await mammoth.convertToHtml({arrayBuffer}); editor.innerHTML = result.value; }catch(err){ alert('Error converting .docx: '+err.message); }
      }else if(name.endsWith('.html')||name.endsWith('.htm')){
        const text = await file.text(); editor.innerHTML = text;
      }else if(name.match(/\.(png|jpg|jpeg)$/)){
        const reader = new FileReader(); reader.onload = ()=> exec('insertHTML', `<img src="${reader.result}" style="max-width:100%;display:block;margin:8px 0">`); reader.readAsDataURL(file);
      }else{
        const text = await file.text(); editor.textContent = text;
      }
      fileInput.value = ''; updateWordCount();
    };

    // Save helpers
    function download(blob, filename){ const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=> URL.revokeObjectURL(url), 10000); }
    document.getElementById('saveHtmlBtn').onclick = ()=>{ const doc = `<!doctype html><html><head><meta charset=\"utf-8\"><title>Document</title></head><body>${editor.innerHTML}</body></html>`; const blob = new Blob([doc], {type:'text/html'}); download(blob, 'document.html'); }
    document.getElementById('saveTxtBtn').onclick = ()=>{ const text = editor.innerText; const blob = new Blob([text], {type:'text/plain'}); download(blob, 'document.txt'); }
    document.getElementById('saveDocxBtn').onclick = ()=>{ try{ const header = '<!doctype html><html><head><meta charset=\"utf-8\"><title>Document</title></head><body>'; const footer = '</body></html>'; const full = header + editor.innerHTML + footer; const converted = window.htmlDocx.asBlob(full, {orientation: 'portrait'}); download(converted, 'document.docx'); }catch(err){ alert('Export to .docx failed: '+err.message+'\\nYou can save as .html instead.'); } }
    document.getElementById('savePdfBtn').onclick = ()=> window.print();

    // Word count
    function updateWordCount(){ const text = editor.innerText.trim().replace(/\\n+/g,' '); const words = text? text.split(/\\s+/).length : 0; document.getElementById('wordCount').textContent = `Words: ${words}`; }
    editor.addEventListener('input', updateWordCount);

    // Active buttons state
    function updateActiveButtons(){ [['boldBtn','bold'],['italicBtn','italic'],['underlineBtn','underline']].forEach(([id,cmd])=>{ const el = document.getElementById(id); const state = document.queryCommandState(cmd); el.classList.toggle('active', state); }); }
    editor.addEventListener('keyup', updateActiveButtons); editor.addEventListener('mouseup', updateActiveButtons);

    // Paste cleanup (plain text by default)
    editor.addEventListener('paste', function(e){ if((e.clipboardData||window.clipboardData).files && (e.clipboardData||window.clipboardData).files.length){ return; } e.preventDefault(); const text = (e.clipboardData || window.clipboardData).getData('text/plain'); document.execCommand('insertHTML', false, text); });

    // Drag & drop images
    editor.addEventListener('dragover', e=> e.preventDefault());
    editor.addEventListener('drop', e=>{ e.preventDefault(); const file = e.dataTransfer.files && e.dataTransfer.files[0]; if(file && file.type.startsWith('image/')){ const reader = new FileReader(); reader.onload = ()=> exec('insertHTML', `<img src="${reader.result}" style="max-width:100%;display:block;margin:8px 0">`); reader.readAsDataURL(file); } });

    // Keyboard shortcuts
    window.addEventListener('keydown', function(e){
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); document.getElementById('saveHtmlBtn').click(); flashStatus('Saved'); }
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='o'){ e.preventDefault(); document.getElementById('openBtn').click(); }
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='f'){ e.preventDefault(); document.getElementById('findBtn').click(); }
    });

    function flashStatus(msg){ const s = document.createElement('span'); s.textContent = msg; s.style.marginLeft='8px'; s.style.fontWeight='600'; document.querySelector('.file-controls').appendChild(s); setTimeout(()=> s.remove(), 1400); }

    // Spellcheck toggle (checkbox created in toolbar)
    document.getElementById('spellToggle')?.addEventListener?.('change', (e)=> editor.spellcheck = e.target.checked);

    // Restore autosave on load & register service worker
    window.addEventListener('load', ()=>{
      const data = localStorage.getItem(AUTOKEY);
      if(data && data.trim()){ if(confirm('Autosaved content found ‚Äî restore it?')){ editor.innerHTML = data; } }
      updateWordCount(); updateActiveButtons();
      registerServiceWorkerAndManifest();
    });

    // helper for inline font-size wrapping
    function wrapSelectionWithStyle(styleObj){
      const sel = window.getSelection();
      if(!sel.rangeCount) return;
      const range = sel.getRangeAt(0);
      if(range.collapsed) return;
      const span = document.createElement('span');
      span.style.cssText = Object.entries(styleObj).map(([k,v])=> `${k}:${v};`).join('');
      try{
        range.surroundContents(span);
        sel.removeAllRanges();
        const newRange = document.createRange();
        newRange.selectNodeContents(span);
        sel.addRange(newRange);
      }catch(err){
        exec('fontSize', '7');
      }
    }

    // ---------- Offline support: dynamic SW + manifest ----------
    async function registerServiceWorkerAndManifest(){
      if(!('serviceWorker' in navigator)) return console.log('Service worker not supported');

      // assets to cache: include the page + libs we rely on
      const assets = [
        location.href,
        location.pathname,
        'https://unpkg.com/mammoth/mammoth.browser.min.js',
        'https://unpkg.com/html-docx-js@0.4.1/dist/html-docx.js'
      ];

      // service worker code as a string (we'll create a blob URL and register it)
      const swCode = `
        const CACHE_NAME = 'mini-word-cache-v1';
        const ASSETS = ${JSON.stringify(assets)};
        self.addEventListener('install', event => {
          event.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(ASSETS)).catch(err=>console.warn('Cache addAll failed',err)));
          self.skipWaiting();
        });
        self.addEventListener('activate', event => { event.waitUntil(self.clients.claim()); });
        self.addEventListener('fetch', event => {
          event.respondWith(
            caches.match(event.request).then(resp => {
              if(resp) return resp;
              return fetch(event.request).then(fetchResp => {
                return caches.open(CACHE_NAME).then(cache => {
                  try{ cache.put(event.request, fetchResp.clone()); }catch(e){ /* cross-origin opaque responses may throw */ }
                  return fetchResp;
                });
              });
            }).catch(()=> caches.match(ASSETS[0]))
          );
        });
      `;

      try{
        const swBlob = new Blob([swCode], {type:'application/javascript'});
        const swUrl = URL.createObjectURL(swBlob);
        await navigator.serviceWorker.register(swUrl, {scope: './'});
        console.log('Service worker registered from blob URL');
      }catch(err){
        console.warn('Service worker registration failed:', err);
      }

      // create a simple manifest (data-uri icon) and link it so browsers can prompt "Add to Home screen"
      try{
        const iconSvg = `<svg xmlns='http://www.w3.org/2000/svg' width='192' height='192'><rect width='100%' height='100%' fill='%23ffffff'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='72' fill='%232563eb'>W</text></svg>`;
        const manifest = {
          name: 'Mini Word', short_name: 'MiniWord', start_url: '.', display: 'standalone',
          background_color: '#ffffff', theme_color: '#2563eb',
          icons: [{ src: 'data:image/svg+xml;utf8,' + encodeURIComponent(iconSvg), sizes: '192x192', type: 'image/svg+xml' }]
        };
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
        const manifestURL = URL.createObjectURL(manifestBlob);
        let link = document.querySelector('link[rel=\"manifest\"]');
        if(!link){ link = document.createElement('link'); link.rel = 'manifest'; document.head.appendChild(link); }
        link.href = manifestURL;
      }catch(err){ console.warn('Manifest creation failed', err); }
    }
  </script>
</body>
</html>
